<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1-Bit Dither Studio</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0a;
    --fg: #e8e8e8;
    --accent: #ffffff;
    --dim: #555;
    --border: #222;
  }

  body {
    background: var(--bg);
    color: var(--fg);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  header {
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  header h1 {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    font-weight: 400;
    letter-spacing: -0.5px;
    color: var(--accent);
  }

  header span {
    color: var(--dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .app {
    display: grid;
    grid-template-columns: 280px 1fr;
    min-height: calc(100vh - 85px);
  }

  .sidebar {
    border-right: 1px solid var(--border);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
  }

  .control-group label {
    display: block;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 8px;
  }

  .control-group select,
  .control-group input[type="range"] {
    width: 100%;
    background: #151515;
    border: 1px solid var(--border);
    color: var(--fg);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    padding: 8px 10px;
    border-radius: 4px;
    outline: none;
    cursor: pointer;
  }

  .control-group select:hover,
  .control-group input[type="range"]:hover {
    border-color: #444;
  }

  input[type="range"] {
    -webkit-appearance: none;
    height: 4px;
    background: #333;
    border: none !important;
    border-radius: 2px;
    padding: 0 !important;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
  }

  .range-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .range-row input { flex: 1; }

  .range-val {
    font-size: 11px;
    color: var(--dim);
    min-width: 32px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .color-row {
    display: flex;
    gap: 8px;
  }

  .color-pick {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .color-pick span {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
  }

  .color-pick input[type="color"] {
    width: 100%;
    height: 32px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: none;
    cursor: pointer;
    padding: 2px;
  }

  .upload-zone {
    border: 2px dashed #333;
    border-radius: 6px;
    padding: 28px 16px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
  }

  .upload-zone:hover,
  .upload-zone.dragover {
    border-color: #666;
    background: #111;
  }

  .upload-zone p {
    color: var(--dim);
    font-size: 11px;
    line-height: 1.6;
  }

  .upload-zone p strong {
    color: var(--fg);
    display: block;
    margin-bottom: 4px;
    font-size: 12px;
  }

  .upload-zone input { display: none; }

  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: auto;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .btn {
    flex: 1;
    padding: 10px 12px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #151515;
    color: var(--fg);
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }

  .btn:hover { background: #222; border-color: #444; }

  .btn.primary {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
    font-weight: 700;
  }

  .btn.primary:hover { background: #ccc; }

  .canvas-area {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    position: relative;
    background:
      radial-gradient(circle at 1px 1px, #181818 1px, transparent 0);
    background-size: 24px 24px;
    overflow: auto;
  }

  .canvas-area.empty::after {
    content: 'Upload an image to begin';
    color: #333;
    font-size: 14px;
    letter-spacing: 1px;
    position: absolute;
  }

  canvas {
    max-width: 100%;
    max-height: calc(100vh - 160px);
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    box-shadow: 0 8px 60px rgba(0,0,0,0.6);
  }

  .hidden-canvas { display: none; }

  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .checkbox-row input[type="checkbox"] {
    accent-color: white;
    width: 14px;
    height: 14px;
  }

  .checkbox-row span {
    font-size: 11px;
    color: var(--fg);
  }

  @media (max-width: 768px) {
    .app { grid-template-columns: 1fr; }
    .sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border);
      max-height: 50vh;
    }
    .canvas-area { min-height: 50vh; }
  }
</style>
</head>
<body>

<header>
  <h1>1-Bit Dither Studio</h1>
  <span>Pixel dithering tool</span>
</header>

<div class="app">
  <div class="sidebar">
    <div class="upload-zone" id="dropZone">
      <p><strong>Drop image here</strong>or click to browse</p>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="control-group">
      <label>Algorithm</label>
      <select id="algorithm">
        <option value="floyd-steinberg">Floyd–Steinberg</option>
        <option value="atkinson">Atkinson</option>
        <option value="ordered4">Ordered 4×4 (Bayer)</option>
        <option value="ordered8">Ordered 8×8 (Bayer)</option>
        <option value="threshold">Threshold</option>
        <option value="random">Random / Noise</option>
      </select>
    </div>

    <div class="control-group">
      <label>Pixel Scale</label>
      <div class="range-row">
        <input type="range" id="pixelSize" min="1" max="10" value="3">
        <span class="range-val" id="pixelSizeVal">3</span>
      </div>
    </div>

    <div class="control-group">
      <label>Threshold</label>
      <div class="range-row">
        <input type="range" id="threshold" min="0" max="255" value="128">
        <span class="range-val" id="thresholdVal">128</span>
      </div>
    </div>

    <div class="control-group">
      <label>Contrast</label>
      <div class="range-row">
        <input type="range" id="contrast" min="-100" max="100" value="20">
        <span class="range-val" id="contrastVal">20</span>
      </div>
    </div>

    <div class="control-group">
      <label>Brightness</label>
      <div class="range-row">
        <input type="range" id="brightness" min="-100" max="100" value="0">
        <span class="range-val" id="brightnessVal">0</span>
      </div>
    </div>

    <div class="control-group">
      <label>Colors</label>
      <div class="color-row">
        <div class="color-pick">
          <span>Foreground</span>
          <input type="color" id="fgColor" value="#000000">
        </div>
        <div class="color-pick">
          <span>Background</span>
          <input type="color" id="bgColor" value="#ffffff">
        </div>
      </div>
    </div>

    <div class="control-group">
      <div class="checkbox-row" onclick="document.getElementById('invert').click()">
        <input type="checkbox" id="invert">
        <span>Invert</span>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn primary" id="saveBtn">PNG</button>
      <button class="btn primary" id="saveSvgBtn">SVG</button>
    </div>
  </div>

  <div class="canvas-area empty" id="canvasArea">
    <canvas id="output"></canvas>
    <canvas id="work" class="hidden-canvas"></canvas>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const output = $('output');
const work = $('work');
const octx = output.getContext('2d');
const wctx = work.getContext('2d');

let sourceImg = null;
let lastResult = null;

// File upload
$('dropZone').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', e => { if(e.target.files[0]) loadImage(e.target.files[0]); });
$('dropZone').addEventListener('dragover', e => { e.preventDefault(); $('dropZone').classList.add('dragover'); });
$('dropZone').addEventListener('dragleave', () => $('dropZone').classList.remove('dragover'));
$('dropZone').addEventListener('drop', e => {
  e.preventDefault();
  $('dropZone').classList.remove('dragover');
  if(e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]);
});

function loadImage(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      sourceImg = img;
      $('canvasArea').classList.remove('empty');
      $('dropZone').querySelector('p').innerHTML = '<strong>✓ ' + file.name + '</strong>Drop or click to replace';
      render();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Controls
const controls = ['algorithm','pixelSize','threshold','contrast','brightness','fgColor','bgColor','invert'];
controls.forEach(id => {
  $(id).addEventListener('input', () => {
    if($( id + 'Val')) $(id + 'Val').textContent = $(id).value;
    render();
  });
});

$('resetBtn').addEventListener('click', () => {
  $('pixelSize').value = 3; $('pixelSizeVal').textContent = '3';
  $('threshold').value = 128; $('thresholdVal').textContent = '128';
  $('contrast').value = 20; $('contrastVal').textContent = '20';
  $('brightness').value = 0; $('brightnessVal').textContent = '0';
  $('algorithm').value = 'floyd-steinberg';
  $('fgColor').value = '#000000';
  $('bgColor').value = '#ffffff';
  $('invert').checked = false;
  render();
});

$('saveBtn').addEventListener('click', () => {
  if(!sourceImg) return;
  const a = document.createElement('a');
  a.download = 'dithered.png';
  a.href = output.toDataURL('image/png');
  a.click();
});

$('saveSvgBtn').addEventListener('click', () => {
  if(!sourceImg || !lastResult) return;

  const { result, sw, sh, scale, fg, bg } = lastResult;
  const w = sw * scale;
  const h = sh * scale;
  const fgHex = rgbToHex(fg);
  const bgHex = rgbToHex(bg);

  let rects = '';

  for(let y = 0; y < sh; y++) {
    let runStart = 0;
    let runVal = result[y * sw];

    for(let x = 1; x <= sw; x++) {
      const val = x < sw ? result[y * sw + x] : -1;
      if(val !== runVal) {
        if(runVal === 0) {
          rects += `<rect x="${runStart * scale}" y="${y * scale}" width="${(x - runStart) * scale}" height="${scale}" fill="${fgHex}"/>`;
        }
        runStart = x;
        runVal = val;
      }
    }
  }

  const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" shape-rendering="crispEdges">
<rect width="${w}" height="${h}" fill="${bgHex}"/>
${rects}
</svg>`;

  const a = document.createElement('a');
  a.download = 'dithered.svg';
  a.href = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

// ---- DITHERING ENGINE ----

function render() {
  if(!sourceImg) return;

  const scale = parseInt($('pixelSize').value);
  const algo = $('algorithm').value;
  const thresh = parseInt($('threshold').value);
  const contrastVal = parseInt($('contrast').value);
  const brightnessVal = parseInt($('brightness').value);
  const invert = $('invert').checked;
  const fgHex = $('fgColor').value;
  const bgHex = $('bgColor').value;

  // Downscale
  const sw = Math.floor(sourceImg.width / scale);
  const sh = Math.floor(sourceImg.height / scale);

  work.width = sw;
  work.height = sh;
  wctx.drawImage(sourceImg, 0, 0, sw, sh);

  const imageData = wctx.getImageData(0, 0, sw, sh);
  const pixels = imageData.data;

  // Convert to grayscale with contrast/brightness
  const gray = new Float32Array(sw * sh);
  const factor = (259 * (contrastVal + 255)) / (255 * (259 - contrastVal));

  for(let i = 0; i < sw * sh; i++) {
    const idx = i * 4;
    let v = 0.299 * pixels[idx] + 0.587 * pixels[idx+1] + 0.114 * pixels[idx+2];
    v = factor * (v - 128) + 128 + brightnessVal;
    gray[i] = Math.max(0, Math.min(255, v));
  }

  // Dither
  const result = new Uint8Array(sw * sh);

  if(algo === 'floyd-steinberg') {
    floydSteinberg(gray, result, sw, sh, thresh);
  } else if(algo === 'atkinson') {
    atkinson(gray, result, sw, sh, thresh);
  } else if(algo === 'ordered4') {
    orderedDither(gray, result, sw, sh, thresh, 4);
  } else if(algo === 'ordered8') {
    orderedDither(gray, result, sw, sh, thresh, 8);
  } else if(algo === 'threshold') {
    thresholdDither(gray, result, sw, sh, thresh);
  } else if(algo === 'random') {
    randomDither(gray, result, sw, sh, thresh);
  }

  // Draw output
  output.width = sw * scale;
  output.height = sh * scale;
  octx.imageSmoothingEnabled = false;

  const fg = hexToRGB(invert ? bgHex : fgHex);
  const bg = hexToRGB(invert ? fgHex : bgHex);

  const outData = octx.createImageData(sw * scale, sh * scale);
  const od = outData.data;

  for(let y = 0; y < sh; y++) {
    for(let x = 0; x < sw; x++) {
      const on = result[y * sw + x];
      const c = on ? bg : fg;
      for(let sy = 0; sy < scale; sy++) {
        for(let sx = 0; sx < scale; sx++) {
          const oi = ((y * scale + sy) * sw * scale + (x * scale + sx)) * 4;
          od[oi] = c[0]; od[oi+1] = c[1]; od[oi+2] = c[2]; od[oi+3] = 255;
        }
      }
    }
  }
  octx.putImageData(outData, 0, 0);

  lastResult = { result, sw, sh, scale, fg, bg };
}

function floydSteinberg(gray, result, w, h, thresh) {
  const g = Float32Array.from(gray);
  for(let y = 0; y < h; y++) {
    for(let x = 0; x < w; x++) {
      const i = y * w + x;
      const old = g[i];
      const val = old < thresh ? 0 : 255;
      result[i] = val > 0 ? 1 : 0;
      const err = old - val;
      if(x+1 < w)             g[i + 1]     += err * 7/16;
      if(y+1 < h && x-1 >= 0) g[i + w - 1] += err * 3/16;
      if(y+1 < h)             g[i + w]     += err * 5/16;
      if(y+1 < h && x+1 < w)  g[i + w + 1] += err * 1/16;
    }
  }
}

function atkinson(gray, result, w, h, thresh) {
  const g = Float32Array.from(gray);
  for(let y = 0; y < h; y++) {
    for(let x = 0; x < w; x++) {
      const i = y * w + x;
      const old = g[i];
      const val = old < thresh ? 0 : 255;
      result[i] = val > 0 ? 1 : 0;
      const err = (old - val) / 8;
      if(x+1 < w) g[i+1] += err;
      if(x+2 < w) g[i+2] += err;
      if(y+1 < h && x-1 >= 0) g[i+w-1] += err;
      if(y+1 < h) g[i+w] += err;
      if(y+1 < h && x+1 < w) g[i+w+1] += err;
      if(y+2 < h) g[i+w*2] += err;
    }
  }
}

function orderedDither(gray, result, w, h, thresh, size) {
  const bayer4 = [
    [0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]
  ];
  const bayer8 = [
    [0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],
    [12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],
    [3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],
    [15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]
  ];
  const matrix = size === 4 ? bayer4 : bayer8;
  const n = size * size;

  for(let y = 0; y < h; y++) {
    for(let x = 0; x < w; x++) {
      const i = y * w + x;
      const bayerVal = matrix[y % size][x % size] / n;
      result[i] = (gray[i] / 255) > bayerVal ? 1 : 0;
    }
  }
}

function thresholdDither(gray, result, w, h, thresh) {
  for(let i = 0; i < w * h; i++) {
    result[i] = gray[i] >= thresh ? 1 : 0;
  }
}

function randomDither(gray, result, w, h, thresh) {
  for(let i = 0; i < w * h; i++) {
    const noise = (Math.random() - 0.5) * 128;
    result[i] = (gray[i] + noise) >= thresh ? 1 : 0;
  }
}

function hexToRGB(hex) {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return [r, g, b];
}

function rgbToHex(rgb) {
  return '#' + rgb.map(v => v.toString(16).padStart(2, '0')).join('');
}
</script>
</body>
</html>
